<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <link rel="stylesheet" href="panel.css">
    <style>
        #listaProductos .producto-item-table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
            font-size: 1rem;
        }
        #listaProductos .producto-item-table th, #listaProductos .producto-item-table td {
            border: 1px solid #b3c6e0;
            padding: 8px 10px;
            text-align: left;
        }
        #listaProductos .producto-item-table th {
            background: #eaf1fb;
            color: #222;
        }
        #listaProductos .even-row { background: #f7fafd; }
        #listaProductos .odd-row { background: #fff; }

        #productoForm {
            background: #f7fafd;
            border: 1.5px solid #b3c6e0;
            border-radius: 12px;
            max-width: 100%;
            width: 96%;
            margin: 30px auto 18px auto;
            padding: 28px 32px 18px 32px;
            box-shadow: 0 2px 12px #0001;
            font-size: 1rem;
            box-sizing: border-box;
        }
        #productoForm div {
            margin-bottom: 16px;
        }
        #productoForm label {
            display: block;
            margin-bottom: 5px;
            color: #222;
            font-weight: 500;
        }
        #productoForm input[type="text"],
        #productoForm input[type="number"],
        #productoForm textarea,
        #productoForm input[type="file"] {
            width: 100%;
            padding: 7px 10px;
            border: 1px solid #b3c6e0;
            border-radius: 5px;
            font-size: 1rem;
            background: #fff;
            box-sizing: border-box;
        }
        #productoForm textarea {
            min-height: 60px;
            resize: vertical;
        }
        #productoForm button[type="submit"] {
            background: #3498db;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 9px 22px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        #productoForm button[type="submit"]:hover {
            background: #217dbb;
        }
        #mensajeProducto {
            margin-top: 10px;
            text-align: center;
            font-size: 1rem;
        }

        #listaProductos .producto-item {
            display: inline-block;
            vertical-align: top;
            margin: 16px 12px 24px 12px;
            padding: 18px 16px 14px 16px;
            border: 1.5px solid #b3c6e0;
            border-radius: 14px;
            min-width: 220px;
            max-width: 260px;
            background: #f7fafd;
            box-shadow: 0 2px 12px #0001;
            transition: box-shadow 0.2s, background 0.2s;
        }
        #listaProductos .producto-item:hover {
            background: #eaf1fb;
            box-shadow: 0 4px 18px #0002;
        }
        #listaProductos .producto-item img {
            max-width: 120px;
            max-height: 80px;
            margin-top: 8px;
            border-radius: 6px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        #listaProductos .producto-nombre {
            font-weight: bold;
            margin: 8px 0 4px 0;
            text-align: center;
        }
        #listaProductos .producto-precio {
            color: #217dbb;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
        }
        #listaProductos .agregar-carrito-btn,
        #listaProductos .editar-btn,
        #listaProductos .eliminar-btn {
            background: #3498db;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 6px 16px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 4px 2px;
            transition: background 0.2s;
        }
        #listaProductos .agregar-carrito-btn:hover,
        #listaProductos .editar-btn:hover,
        #listaProductos .eliminar-btn:hover {
            background: #217dbb;
        }
    </style>
</head>
<body>
    <header>
        <nav style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h1 style="display:inline-block; margin-right: 30px;">Panel de Administración</h1>
                <a href="panel.html">Productos</a>
                <a href="stock.html">Stock</a>
                <a href="usuarios.html">Usuarios</a>
                <a href="ventas.html">Ventas</a>
                <a href="detalle_venta.html">Detalles de Venta</a>
            </div>
            <div id="userSection">
                <span id="userName"></span>
                <button id="logoutBtn" style="display: none;">Cerrar Sesión</button>
            </div>
        </nav>
    </header>

    <main>
        <h2>Bienvenido al Panel de Administración</h2>
        <div id="adminContent">
            <h3>Registrar Producto</h3>
            <form id="productoForm">
                <div>
                    <label for="nombre">Nombre:</label>
                    <input type="text" id="nombre" name="nombre" required>
                </div>
                <div>
                    <label for="precio_venta">Precio de Venta:</label>
                    <input type="number" id="precio_venta" name="precio_venta" min="0" step="0.01" required>
                </div>
                <div>
                    <label for="descripcion">Descripción:</label>
                    <textarea id="descripcion" name="descripcion" required></textarea>
                </div>
                <div>
                    <label for="imagen">Imagen:</label>
                    <input type="file" id="imagen" name="imagen" accept="image/*" required>
                    <br>
                    <img id="previewImagen" src="#" alt="Preview" style="display:none;max-width:120px;max-height:80px;margin-top:8px;" />
                </div>
                <div>
                    <label for="categoria">Categoría:</label>
                    <input type="text" id="categoria" name="categoria" required>
                </div>
                <div>
                    <label for="marca">Marca:</label>
                    <input type="text" id="marca" name="marca" required>
                </div>
                <button type="submit">Registrar Producto</button>
            </form>
            <div id="mensajeProducto"></div>
            <hr>
            <h3>Lista de Productos</h3>
            <div id="listaProductos"></div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Sesión y logout ---
            const userSection = document.getElementById('userSection');
            const userName = document.getElementById('userName');
            const logoutBtn = document.getElementById('logoutBtn');
            const usuario = JSON.parse(localStorage.getItem('usuario'));
            if (usuario && usuario.rol === 'admin') {
                userName.textContent = `Administrador: ${usuario.nombre}`;
                logoutBtn.style.display = 'inline-block';
            } else {
                window.location.href = 'iniciar.html';
            }
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('usuario');
                window.location.href = 'iniciar.html';
            });

            // --- Funciones auxiliares ---
            function toBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            async function obtenerProductos() {
                listaProductos.innerHTML = 'Cargando...';
                try {
                    const response = await fetch('http://localhost:3000/api/imagenes/productos');
                    const data = await response.json();
                    if (response.ok && data.success && Array.isArray(data.data)) {
                        if (data.data.length === 0) {
                            listaProductos.innerHTML = '<p>No hay productos registrados.</p>';
                        } else {
                            listaProductos.innerHTML = data.data.map(prod => `
                                <div class=\"producto-item\" style=\"display:inline-block;vertical-align:top;margin:10px;padding:10px;border:1px solid #ccc;border-radius:8px;min-width:220px;max-width:240px;\">\n                                    <strong>${prod.nombre}</strong><br>\n                                    <span>$${prod.precio_venta}</span><br>\n                                    <em>${prod.categoria} | ${prod.marca}</em><br>\n                                    <span>${prod.descripcion}</span><br>\n                                    ${prod.imagen ? `<img src=\"${prod.imagen}\" alt=\"${prod.nombre}\" style=\"max-width:120px;max-height:80px;margin-top:8px;\">` : '<span style=\"color:#888;\">Sin imagen</span>'}\n                                    <br>\n                                    <button class=\"editar-btn\" data-id=\"${prod.id_producto}\">Editar</button>\n                                    <button class=\"eliminar-btn\" data-id=\"${prod.id_producto}\">Eliminar</button>\n                                </div>\n                            `).join('');

                            // Asignar eventos a los botones de eliminar
                            document.querySelectorAll('.eliminar-btn').forEach(btn => {
                                btn.addEventListener('click', async function() {
                                    const id = this.getAttribute('data-id');
                                    if (confirm('¿Seguro que deseas eliminar este producto?')) {
                                        try {
                                            const response = await fetch(`http://localhost:3000/api/productos/${id}`, {
                                                method: 'DELETE'
                                            });
                                            const data = await response.json();
                                            if (response.ok && data.success) {
                                                mensajeProducto.innerHTML = '<span style="color:green">Producto eliminado correctamente.</span>';
                                                obtenerProductos();
                                            } else {
                                                mensajeProducto.innerHTML = `<span style='color:red'>${data.message || 'Error al eliminar producto'}</span>`;
                                            }
                                        } catch (error) {
                                            mensajeProducto.innerHTML = `<span style='color:red'>Error al conectar con el servidor (eliminar): ${error}</span>`;
                                        }
                                    }
                                });
                            });

                            // Asignar eventos a los botones de editar
                            document.querySelectorAll('.editar-btn').forEach(btn => {
                                btn.addEventListener('click', async function() {
                                    const id = this.getAttribute('data-id');
                                    // Buscar el producto en la lista
                                    const prod = data.data.find(p => p.id_producto == id);
                                    if (prod) {
                                        document.getElementById('nombre').value = prod.nombre;
                                        document.getElementById('precio_venta').value = prod.precio_venta;
                                        document.getElementById('descripcion').value = prod.descripcion;
                                        document.getElementById('categoria').value = prod.categoria;
                                        document.getElementById('marca').value = prod.marca;
                                        // Mostrar preview de imagen actual
                                        if (prod.imagen) {
                                            previewImagen.src = prod.imagen;
                                            previewImagen.style.display = 'block';
                                        } else {
                                            previewImagen.src = '#';
                                            previewImagen.style.display = 'none';
                                        }
                                        // Guardar id en un atributo del formulario para saber que es edición
                                        productoForm.setAttribute('data-edit-id', id);
                                        mensajeProducto.innerHTML = '<span style="color:blue">Editando producto. Guarda para actualizar.</span>';
                                    }
                                });
                            });
                        }
                    } else {
                        listaProductos.innerHTML = '<p>Error al cargar productos.</p>';
                    }
                } catch (error) {
                    listaProductos.innerHTML = '<p>Error al conectar con el servidor.</p>';
                }
            }

            // --- Preview de imagen ---
            const imagenInput = document.getElementById('imagen');
            const previewImagen = document.getElementById('previewImagen');
            imagenInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImagen.src = e.target.result;
                        previewImagen.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    previewImagen.src = '#';
                    previewImagen.style.display = 'none';
                }
            });

            // --- Registro de productos ---
            const productoForm = document.getElementById('productoForm');
            const mensajeProducto = document.getElementById('mensajeProducto');
            const listaProductos = document.getElementById('listaProductos');

            // Mostrar productos al cargar
            obtenerProductos();

            productoForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                mensajeProducto.textContent = '';
                const formData = new FormData(productoForm);
                const imagenFile = formData.get('imagen');
                const editId = productoForm.getAttribute('data-edit-id');
                if (!editId) {
                    // 1. Registrar producto sin imagen
                    const producto = {
                        nombre: formData.get('nombre'),
                        precio_venta: formData.get('precio_venta'),
                        descripcion: formData.get('descripcion'),
                        categoria: formData.get('categoria'),
                        marca: formData.get('marca')
                    };

                    let productoId = null;
                    try {
                        const response = await fetch('http://localhost:3000/api/productos', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(producto)
                        });
                        const data = await response.json();
                        // Buscar el id en data.data.id_producto o en data.id
                        productoId = (data.data && data.data.id_producto) || data.id_producto || data.id;
                        if (response.ok && data.success && productoId) {
                            mensajeProducto.innerHTML = `<span style='color:green'>Producto creado. ID: ${productoId}</span>`;
                        } else {
                            mensajeProducto.innerHTML = `<span style='color:red'>${data.message || 'Error al registrar producto'}<br>Respuesta: ${JSON.stringify(data)}</span>`;
                            return;
                        }
                    } catch (error) {
                        mensajeProducto.innerHTML = `<span style='color:red'>Error al conectar con el servidor (producto): ${error}</span>`;
                        return;
                    }

                    // 2. Subir imagen usando endpoint de imagenes
                    try {
                        const base64Imagen = await toBase64(imagenFile);
                        const imagenPayload = { imagen: base64Imagen };
                        const responseImg = await fetch(`http://localhost:3000/api/imagenes/subir/productos/imagen/${productoId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(imagenPayload)
                        });
                        const dataImg = await responseImg.json();
                        if (responseImg.ok && dataImg.success) {
                            mensajeProducto.innerHTML += `<br><span style='color:green'>Imagen subida correctamente.</span>`;
                            productoForm.reset();
                            previewImagen.src = '#';
                            previewImagen.style.display = 'none';
                            obtenerProductos();
                        } else {
                            mensajeProducto.innerHTML += `<br><span style='color:red'>Error al subir la imagen: ${dataImg.error || JSON.stringify(dataImg)}</span>`;
                        }
                    } catch (error) {
                        mensajeProducto.innerHTML += `<br><span style='color:red'>Error al subir la imagen: ${error}</span>`;
                    }
                } else {
                    // --- Actualizar producto ---
                    const producto = {
                        nombre: formData.get('nombre'),
                        precio_venta: formData.get('precio_venta'),
                        descripcion: formData.get('descripcion'),
                        categoria: formData.get('categoria'),
                        marca: formData.get('marca')
                    };
                    try {
                        const response = await fetch(`http://localhost:3000/api/productos/${editId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(producto)
                        });
                        const data = await response.json();
                        if (response.ok && data.success) {
                            // Si hay nueva imagen, actualizarla
                            if (imagenFile && imagenFile.size > 0) {
                                try {
                                    const base64Imagen = await toBase64(imagenFile);
                                    const imagenPayload = { imagen: base64Imagen };
                                    const responseImg = await fetch(`http://localhost:3000/api/imagenes/subir/productos/imagen/${editId}`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify(imagenPayload)
                                    });
                                    const dataImg = await responseImg.json();
                                    if (responseImg.ok && dataImg.success) {
                                        mensajeProducto.innerHTML = '<span style="color:green">Producto actualizado y nueva imagen guardada.</span>';
                                    } else {
                                        mensajeProducto.innerHTML = `<span style='color:orange'>Producto actualizado, pero error al actualizar imagen: ${dataImg.error || JSON.stringify(dataImg)}</span>`;
                                    }
                                } catch (error) {
                                    mensajeProducto.innerHTML = `<span style='color:orange'>Producto actualizado, pero error al actualizar imagen: ${error}</span>`;
                                }
                            } else {
                                mensajeProducto.innerHTML = '<span style="color:green">Producto actualizado.</span>';
                            }
                            productoForm.reset();
                            previewImagen.src = '#';
                            previewImagen.style.display = 'none';
                            productoForm.removeAttribute('data-edit-id');
                            obtenerProductos();
                        } else {
                            mensajeProducto.innerHTML = `<span style='color:red'>${data.message || 'Error al actualizar producto'}</span>`;
                        }
                    } catch (error) {
                        mensajeProducto.innerHTML = `<span style='color:red'>Error al conectar con el servidor (actualizar): ${error}</span>`;
                    }
                }
            });
        });
    </script>
</body>
</html>